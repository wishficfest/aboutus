<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wish Fic Fest ‚Äî Prompt Bank</title>
<meta name="theme-color" content="#f3e7d4" />
<style>
  :root{ --parchment:#f3e7d4; --ink:#222; --sage:#6e8b72; --lace:#fff; --stitch:#e8d9bf; --gold:#c99a2e; --muted:#6d5f4f }
  html,body{margin:0;background:var(--parchment);color:var(--ink);font-family:"Iowan Old Style", Garamond, Georgia, ui-serif, serif}
  *,*::before,*::after{box-sizing:border-box}

  .wrap{max-width:1100px;margin:auto;padding:22px}
  h1{margin:4px 0 10px;font-size:clamp(28px,6vw,54px);font-weight:700;font-variant:small-caps}
  h2{margin:0 0 10px;color:var(--gold);font-size:clamp(20px,3.4vw,30px)}
  p{margin:8px 0}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid #d8c9ad;border-radius:12px;background:#fff;color:#222;text-decoration:none;font-weight:800}
  .btn:hover{filter:brightness(.97)}
  .btn.sage{background:var(--sage);color:#fff;border-color:transparent}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 14px}

  .card{background:var(--lace);border:2px dashed var(--stitch);border-radius:18px;box-shadow:0 10px 22px rgba(0,0,0,.08);padding:16px 18px;margin:12px 0}

  /* Controls */
  .controls{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px}
  .controls .row{display:flex;gap:8px;align-items:center}
  .inp, select{width:100%;padding:10px 12px;border:1px solid #d8c9ad;border-radius:10px;background:#fff;font-weight:600}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff7df;border:1px solid #e7d9bd;font-weight:800;font-size:.9rem}
  .switch{display:inline-flex;align-items:center;gap:8px;font-weight:800}
  .switch input{width:18px;height:18px}

  /* Grid */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:860px){ .controls{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }

  /* Prompt card */
  .prompt{background:#fff;border:2px dashed var(--stitch);border-radius:14px;padding:14px 14px 12px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .title{font-weight:900;font-size:1.05rem}
  .meta{font-size:.9rem;color:var(--muted)}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{padding:4px 8px;border-radius:999px;background:#eef6f0;border:1px solid #d9eae1;font-weight:800;font-size:.8rem}
  .tag.rate{background:#fff2e2;border-color:#f0d7b8}
  .actions{display:flex;gap:8px;align-items:center}
  .actions .btn{padding:8px 10px;font-size:.95rem}
  .empty{padding:14px;border:2px dashed #e2d3b7;border-radius:12px;text-align:center;opacity:.8}

  /* Modal (paste JSON) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{background:#fff;border:2px dashed var(--stitch);border-radius:16px;max-width:760px;width:100%;padding:14px}
  textarea{width:100%;min-height:220px;padding:10px;border:1px solid #d8c9ad;border-radius:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .right{margin-left:auto}
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <a class="btn" href="index.html">‚Üê Back to Front Page</a>
      <a class="btn" href="dosandonts.html">‚úÖ Do's & Don'ts</a>
      <a class="btn" href="https://archiveofourown.org/collections/WishfulThoughtsFest2025/requests" target="_blank" rel="noopener">üß≠ Buka di AO3</a>
    </div>

    <h1>Prompt Bank</h1>
    <p class="pill">Dashboard prompt yang belum ke-claim. Open discussion, easier search ‚ú®</p>

    <section class="card">
      <h2>Cari & Filter</h2>
      <div class="controls" style="margin-top:6px">
        <input id="q" class="inp" placeholder="Cari judul, pairing, ringkasan, tag‚Ä¶" />
        <select id="rating">
          <option value="">Semua Rating</option>
          <option>G</option><option>T</option><option>M</option><option>E</option><option>NR</option>
        </select>
        <input id="pairing" class="inp" placeholder="Pairing (mis. Sion/Riku)" />
        <div class="row">
          <label class="switch"><input id="showClaimed" type="checkbox" /> Tampilkan yang sudah claimed</label>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnClear">Reset Filter</button>
        <span class="right pill" id="count">0 prompt</span>
      </div>
    </section>

    <section class="card">
      <h2>Daftar Prompt</h2>
      <div id="list" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>Belum ada data. Klik ‚ÄúImport JSON‚Äù untuk masukin daftar prompt, atau kurasi manual lewat tombol ‚ÄúTambah‚Äù.</div>
      <div class="toolbar">
        <button class="btn" id="btnAdd">Ôºã Tambah</button>
        <button class="btn" id="btnImport">‚¨ÜÔ∏è Import JSON</button>
        <input type="file" id="fileImport" accept="application/json" hidden />
        <button class="btn" id="btnPaste">üìã Paste JSON</button>
        <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
      </div>
    </section>

    <div class="toolbar">
      <a class="btn" href="prompting.html">üìù Buka Form Prompting</a>
      <a class="btn" href="claiming.html">üìå Panduan Claiming</a>
    </div>
  </div>

  <!-- Paste JSON modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="toolbar"><strong>Import JSON (Paste)</strong><button class="btn right" id="closeModal">Tutup</button></div>
      <p style="opacity:.9">Tempel JSON array berisi prompt (format bebas ‚Äî akan di-normalisasi). Data disimpan ke <em>localStorage</em> perangkat ini.</p>
      <textarea id="jsonInput" placeholder='[
  {"id":"ao3-123","title":"Only-one-bed di rest area","pairing":"Sion/Riku","summary":"Road-trip macet, penginapan penuh; harus berbagi kasur.","rating":"T","tags":["AU","only one bed"],"url":"https://archiveofourown.org/works/...","type":"request","claimed":false}
]'></textarea>
      <div class="toolbar"><button class="btn sage" id="doImport">Import Sekarang</button></div>
    </div>
  </div>

<script>
(() => {
  // ===== Config / State =====
  const LS_KEY = 'wffPromptBank';
  const AO3_REQ = 'https://archiveofourown.org/collections/WishfulThoughtsFest2025/requests';
  const SEED_URL = 'wff-ao3-requests.json'; // <‚Äî your uploaded file

  /** @type {Array<Prompt>} */
  let prompts = [];

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const escapeHTML = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // Lenient normalizer ‚Äî handles many possible field names
  function normalize(x) {
    if (!x || typeof x !== 'object') return null;
    const id   = x.id || x.prompt_id || x.work_id || x.url || crypto.randomUUID();
    const url  = x.url || x.link || x.ao3_url || AO3_REQ;
    const title= x.title || x.name || x.prompt_title || '(untitled)';
    const pairing = x.pairing || x.relationship || x.relationships || x.ship || '';
    const summary = x.summary || x.description || x.notes || x.note || '';
    const rating  = (x.rating || x.rated || 'NR').toString();
    const tagsRaw = x.tags || x.additional_tags || x.tag_list || [];
    const tags    = Array.isArray(tagsRaw) ? tagsRaw : String(tagsRaw||'').split(',').map(s=>s.trim()).filter(Boolean);
    const type    = x.type || x.source || (x.self ? 'self' : 'request');
    const claimed = !!(x.claimed || x.is_claimed || (typeof x.status==='string' && x.status.toLowerCase().includes('claim')));
    return { id, title, pairing, summary, rating, tags, url, type, claimed };
  }

  // ===== Persistence =====
  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(prompts));
  const loadLS = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
    catch { return []; }
  };

  // ===== Rendering =====
  const list = $('#list'), empty = $('#empty'), count = $('#count');
  const q = $('#q'), rating = $('#rating'), pairing = $('#pairing'), showClaimed = $('#showClaimed');

  const tag = (t, cls='') => `<span class="tag ${cls}">${escapeHTML(t)}</span>`;

  function card(p) {
    const status = p.claimed ? 'claimed' : 'unclaimed';
    const linkBtn = `<a class="btn" href="${escapeHTML(p.url || AO3_REQ)}" target="_blank" rel="noopener">üîó Lihat di AO3</a>`;
    const claimBtn = p.claimed ? '' : `<a class="btn sage" href="${AO3_REQ}" target="_blank" rel="noopener">Claim on AO3</a>`;
    return `
      <article class="prompt">
        <div>
          <div class="title">${escapeHTML(p.title)}</div>
          <div class="meta">${escapeHTML(p.pairing || '‚Äî')} ‚Ä¢ Rating ${escapeHTML(p.rating || 'NR')} ‚Ä¢ <span class="status ${status}">${status}</span> ‚Ä¢ ${escapeHTML(p.type||'request')}</div>
          ${p.summary ? `<p style="margin:6px 0 4px">${escapeHTML(p.summary)}</p>` : ''}
          <div class="tags">
            ${tag(p.rating||'NR','rate')}
            ${(p.tags||[]).slice(0,10).map(t=>tag(t)).join('')}
          </div>
        </div>
        <div class="actions">
          ${linkBtn}
          ${claimBtn}
        </div>
      </article>`;
  }

  function match(p){
    const text = (q.value||'').toLowerCase();
    const pair = (pairing.value||'').toLowerCase();
    if (rating.value && (p.rating||'').toUpperCase() !== rating.value.toUpperCase()) return false;
    if (!showClaimed.checked && p.claimed) return false;
    if (pair && !String(p.pairing||'').toLowerCase().includes(pair)) return false;
    if (text){
      const blob = `${p.title} ${p.pairing} ${p.summary} ${(p.tags||[]).join(' ')}`.toLowerCase();
      if (!blob.includes(text)) return false;
    }
    return true;
  }

  function render(){
    const items = prompts.filter(Boolean).filter(match);
    list.innerHTML = items.map(card).join('');
    empty.hidden = items.length !== 0;
    count.textContent = `${items.length} prompt`;
  }

  // ===== Import / Export =====
  function loadArray(arr){
    prompts = (arr||[]).map(normalize).filter(Boolean);
    save(); render();
  }

  async function trySeedJSON(){
    try{
      const res = await fetch(SEED_URL + '?v=' + Date.now(), {cache:'no-store'});
      if (!res.ok) throw new Error(String(res.status));
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (json.items || json.prompts || []);
      if (!arr.length) throw new Error('JSON kosong');
      loadArray(arr);
      console.info('Loaded seed from', SEED_URL, `(${arr.length} items)`);
      return true;
    }catch(e){
      console.info('Seed JSON not found/invalid ‚Äî', e.message || e);
      return false;
    }
  }

  // Buttons
  $('#btnClear').onclick = ()=>{ q.value=''; rating.value=''; pairing.value=''; showClaimed.checked=false; render(); };
  [q, rating, pairing, showClaimed].forEach(el=> el.addEventListener('input', render));

  // Add manual
  $('#btnAdd').onclick = () => {
    const title = prompt('Judul/ide singkat?'); if(!title) return;
    const pairingV = prompt('Pairing? (mis. Sion/Riku)')||'';
    const ratingV = prompt('Rating? (G/T/M/E/NR)')||'NR';
    const summary = prompt('Ringkasan 1-2 kalimat?')||'';
    const tags = (prompt('Tag (pisahkan koma)')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const url = prompt('Link AO3 (opsional)')||AO3_REQ;
    prompts.unshift({ id:`local-${Date.now()}`, title, pairing:pairingV, rating:ratingV, summary, tags, url, type:'request', claimed:false });
    save(); render();
  };

  // File import
  $('#btnImport').onclick = ()=> $('#fileImport').click();
  $('#fileImport').addEventListener('change', async ev=>{
    const file = ev.target.files?.[0];
    if (!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      const arr = Array.isArray(json) ? json : (json.items || json.prompts || []);
      loadArray(arr);
    }catch(e){ alert('Gagal baca JSON: ' + e.message); }
    ev.target.value = '';
  });

  // Paste import
  const modal = $('#modal');
  const openModal = ()=> modal.style.display='flex';
  const closeModal = ()=> modal.style.display='none';
  $('#btnPaste').onclick = openModal;
  $('#closeModal').onclick = closeModal;
  $('#doImport').onclick = ()=>{
    try{
      const raw = $('#jsonInput').value || '[]';
      const json = JSON.parse(raw);
      const arr = Array.isArray(json) ? json : (json.items || json.prompts || []);
      loadArray(arr);
      closeModal();
    }catch(e){ alert('Gagal import: ' + e.message); }
  };

  // Export
  $('#btnExport').onclick = ()=>{
    const blob = new Blob([JSON.stringify(prompts, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'promptbank.json'; a.click();
    URL.revokeObjectURL(url);
  };

  // ===== Bootstrap order =====
  (async function init(){
    // 1) Use existing localStorage if present
    const fromLS = loadLS();
    if (fromLS.length) {
      prompts = fromLS.map(normalize).filter(Boolean);
      render();
      // also try to refresh from seed silently (won‚Äôt overwrite, but you can click Import to update)
      return;
    }
    // 2) Try to pull your uploaded seed JSON
    const seeded = await trySeedJSON();
    if (seeded) return;
    // 3) Last resort: tiny sample so the page isn‚Äôt empty
    prompts = [
      { id:'req-001', title:'Meet-cute di toko buku lama', pairing:'A/B', summary:'Salah paham lucu soal buku langka.', rating:'G', tags:['fluff','slice of life','bookshop'], url:AO3_REQ, type:'request', claimed:false },
      { id:'req-002', title:'Only-one-bed saat road-trip', pairing:'Sion/Riku', summary:'Macet, penginapan penuh; harus berbagi kasur.', rating:'T', tags:['AU','only one bed','road-trip'], url:AO3_REQ, type:'request', claimed:false }
    ];
    save(); render();
  })();
})();
</script>
</body>
</html>
