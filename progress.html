<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Author Progress ‚Äî Wish Fic Fest</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{ --parchment:#f3e7d4; --ink:#222; --card:#fff; --muted:#6d5f4f }
  body{margin:0;background:var(--parchment);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  .grid{display:grid;gap:20px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
  h1{font-size:28px;margin:0 0 8px}
  h3{margin:0 0 6px}
  .muted{color:var(--muted)}
  .legend{margin-top:10px;font-size:14px}
  .bar{display:flex;gap:12px;align-items:center;margin:8px 0 18px}
  .btn{padding:8px 12px;border:0;border-radius:10px;background:#2f6b4f;color:#fff;cursor:pointer}
  .small{font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar" style="margin-top:0">
      <button class="btn" onclick="history.back()">‚Üê Back</button>
      <h1 style="margin:0 0 0 8px">üìä Author Progress</h1>
    </div>
    <div class="muted small">Real-time check-in progress (anonymous, berbasis jumlah check-in yang masuk).</div>

    <div class="bar">
      <button id="btnRefresh" class="btn">Refresh Data</button>
      <span id="lastUpdated" class="muted small"></span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Each Progress <span id="totalSpan" class="muted small"></span></h3>
        <canvas id="chartStatus" height="320"></canvas>
        <div id="statusList" class="legend"></div>
      </div>

      <div class="card">
        <h3>Overall Progress</h3>
        <canvas id="chartOverall" height="320"></canvas>
        <div id="overallText" class="legend"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
  // ====== GANTI dengan URL Web App doGet() kamu ======
  const ENDPOINT_BASE = "https://script.google.com/macros/s/AKfycbwxyz12345/exec";
  const REFRESH_MS = 60000;

  // Harus sama persis dengan opsi di Google Form
  const STATUS_ORDER = [
    "Belum mulai (0%)",
    "Masih outline / planning (20%)",
    "Lagi nulis draft (40%)",
    "Hampir kelar draft (60%)",
    "Selesai draft, lagi finishing (80%)",
    "Sudah lengkap / selesai (100%)"
  ];

  let chart1=null, chart2=null;
  const pct = (n,t)=> t?`${Math.round(n/t*100)}%`:'0%';

  async function loadData(){
    const url = `${ENDPOINT_BASE}?t=${Date.now()}`; // cache buster
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('Fetch failed');
    return res.json();
  }

  function render(payload){
    // total = jumlah RESPON yang mengisi kolom progress (dinamis)
    const total = Number(payload.total||0);
    const by = payload.by_status||{};

    if (chart1) chart1.destroy();
    if (chart2) chart2.destroy();

    if (!total){
      document.getElementById('totalSpan').textContent = '(0 check-in)';
      document.getElementById('statusList').textContent = 'Belum ada data check-in.';
      document.getElementById('overallText').textContent = 'Belum ada data.';
      chart1 = new Chart(document.getElementById('chartStatus').getContext('2d'), {type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{display:false}}}});
      chart2 = new Chart(document.getElementById('chartOverall').getContext('2d'), {type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{display:false}}}});
      return;
    }

    // susun data sesuai urutan tetap
    const labels=[], counts=[];
    STATUS_ORDER.forEach(l=>{ labels.push(l); counts.push(by[l]||0); });

    // Chart 1: distribusi progress (berbasis total check-in)
    chart1 = new Chart(document.getElementById('chartStatus').getContext('2d'), {
      type:'pie',
      data:{ labels, datasets:[{ data:counts }] },
      options:{ plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=>{
        const c = ctx.parsed||0; return `${ctx.label}: ${c}/${total} (${pct(c,total)})`;
      }}}}}
    });

    // List ringkas: "2/X : Lagi nulis draft (40%)"
    document.getElementById('statusList').innerHTML =
      labels.map((l,i)=>`${counts[i]}/${total} : ${l}`).join('<br>');
    document.getElementById('totalSpan').textContent = `(${total} check-in)`;

    // Chart 2: overall started vs not started (berbasis total check-in)
    const notStarted = by["Belum mulai (0%)"]||0;
    const started = Math.max(total-notStarted,0);
    chart2 = new Chart(document.getElementById('chartOverall').getContext('2d'), {
      type:'pie',
      data:{ labels:["Belum mulai","Sudah mulai"], datasets:[{ data:[notStarted, started] }] },
      options:{ plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=>{
        const c = ctx.parsed||0; return `${ctx.label}: ${c}/${total} (${pct(c,total)})`;
      }}}}}
    });
    document.getElementById('overallText').textContent =
      `Overall (berdasarkan ${total} check-in): ${pct(notStarted,total)} Belum mulai ¬∑ ${pct(started,total)} Sudah mulai`;
  }

  async function refresh(){
    try{
      const data = await loadData();
      render(data);
      document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }catch(e){
      console.error(e);
      document.getElementById('lastUpdated').textContent = 'Gagal ambil data (cek ENDPOINT & izin Web App).';
    }
  }

  document.getElementById('btnRefresh').addEventListener('click', refresh);
  refresh();
  setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
