<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Author Progress — Wish Fic Fest</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{ --parchment:#f3e7d4; --ink:#222; --card:#fff; --muted:#6d5f4f; --accent:#2f6b4f }
    *{box-sizing:border-box}
    body{margin:0;background:var(--parchment);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e7e0d2;color:#333}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    /* Hero */
    .hero{ text-align:center; margin:22px 0 6px }
    .hero h1{ font-size:40px; margin:0 0 12px }
    .quick{ display:grid; grid-template-columns:1fr 1fr; gap:18px; max-width:820px; margin:0 auto 8px }
    .quick .card{ background:#fff; border-radius:14px; padding:12px 16px; box-shadow:0 8px 22px rgba(0,0,0,.06) }
    .quick h3{ margin:0; font-size:20px; text-align:center; line-height:1.2 }
    .quick a{ display:inline-block; margin-top:4px; font-weight:700 }
    /* Charts */
    .grid{display:grid;gap:22px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
    h2{margin:0 0 8px;font-size:22px}
    .muted{color:var(--muted)}
    .legend{margin-top:10px;font-size:14px}
    /* CTA */
    .cta-grid{ display:grid; gap:24px; grid-template-columns:1fr 1fr; align-items:start; margin:38px auto 10px; max-width:980px }
    .cta{ background:#fff; border-radius:16px; padding:22px; box-shadow:0 10px 24px rgba(0,0,0,.06) }
    .cta h3{ margin:0 0 10px; font-size:26px; text-align:center }
    .btn-cta{ display:block; text-align:center; background:var(--accent); color:#fff; padding:14px 18px; border-radius:12px; font-weight:700 }
    .btn-cta:hover{ filter:brightness(.95) }
    @media(max-width:900px){ .cta-grid{ grid-template-columns:1fr } .quick{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <button class="btn secondary" onclick="history.back()">← Back</button>
      <a class="btn secondary" href="index.html">← back to page</a>
    </div>

    <!-- HERO -->
    <div class="hero">
      <h1>Thank you so much for signing up, dear author!</h1>
      <div class="quick">
        <div class="card">
          <h3>Progress all<br><a href="#progress-all">&gt; open</a></h3>
        </div>
        <div class="card">
          <h3>Progress status<br><a href="#progress-overall">&gt; open</a></h3>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="row">
      <button id="btnRefresh" class="btn">Refresh Data</button>
      <span class="muted">Real-time check-in progress (anonymous, berbasis jumlah check-in yang masuk).</span>
    </div>
    <div class="row muted" id="lastUpdated">Gagal ambil data (cek ENDPOINT & izin Web App).</div>

    <!-- CHARTS -->
    <div class="grid">
      <div class="card" id="progress-all">
        <h2>Each Progress <span id="totalSpan" class="muted"></span></h2>
        <canvas id="chartStatus" height="320"></canvas>
        <div id="statusList" class="legend"></div>
      </div>

      <div class="card" id="progress-overall">
        <h2>Overall Progress</h2>
        <canvas id="chartOverall" height="320"></canvas>
        <div id="overallText" class="legend"></div>
      </div>
    </div>

    <!-- CTA LINKS -->
    <div class="cta-grid">
      <div class="cta">
        <h3>Checkin form</h3>
        <!-- TODO: replace with your actual Google Form link -->
        <a class="btn-cta" href="YOUR_GOOGLE_FORM_URL" target="_blank" rel="noopener">Open Check-in Form</a>
      </div>
      <div class="cta">
        <h3>AO3 Pages</h3>
        <a class="btn-cta" href="https://archiveofourown.org/collections/WishfulThoughtsFest2025/works" target="_blank" rel="noopener">
          Open AO3 Works
        </a>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ====== SET THIS ======
    const ENDPOINT_BASE = "PASTE_YOUR_WEB_APP_EXEC_URL_HERE"; // ex: https://script.google.com/macros/s/AKfy.../exec
    const REFRESH_MS = 60000;

    // Must match your Google Form labels exactly
    const STATUS_ORDER = [
      "Belum mulai (0%)",
      "Masih outline / planning (20%)",
      "Lagi nulis draft (40%)",
      "Hampir kelar draft (60%)",
      "Selesai draft, lagi finishing (80%)",
      "Sudah lengkap / selesai (100%)"
    ];

    let chart1=null, chart2=null;
    const pct = (n,t)=> t?`${Math.round(n/t*100)}%`:'0%';

    // JSONP loader (avoids CORS with Apps Script)
    function loadFromWebApp() {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now();
        window[cb] = (data) => { try { resolve(data); } finally { cleanup(); } };
        const s = document.createElement('script');
        s.src = `${ENDPOINT_BASE}?callback=${cb}&t=${Date.now()}`;
        s.onerror = () => { cleanup(); reject(new Error("JSONP error")); };
        document.body.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }

    async function loadData(){ return loadFromWebApp(); }

    function render(payload){
      const total = Number(payload.total||0);
      const by = payload.by_status||{};
      if (chart1) chart1.destroy(); if (chart2) chart2.destroy();

      if (!total){
        document.getElementById('totalSpan').textContent = '(0 check-in)';
        document.getElementById('statusList').textContent = 'Belum ada data check-in.';
        document.getElementById('overallText').textContent = 'Belum ada data.';
        chart1 = new Chart(document.getElementById('chartStatus').getContext('2d'), {type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{display:false}}}});
        chart2 = new Chart(document.getElementById('chartOverall').getContext('2d'), {type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{display:false}}}});
        return;
      }

      const labels=[], counts=[];
      STATUS_ORDER.forEach(l=>{ labels.push(l); counts.push(by[l]||0); });

      chart1 = new Chart(document.getElementById('chartStatus').getContext('2d'), {
        type:'pie',
        data:{ labels, datasets:[{ data:counts }] },
        options:{ plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=>{
          const c = ctx.parsed||0; return `${ctx.label}: ${c}/${total} (${pct(c,total)})`;
        }}}}}
      });

      document.getElementById('statusList').innerHTML =
        labels.map((l,i)=>`${counts[i]}/${total} : ${l}`).join('<br>');
      document.getElementById('totalSpan').textContent = `(${total} check-in)`;

      const notStarted = by["Belum mulai (0%)"]||0;
      const started = Math.max(total-notStarted,0);
      chart2 = new Chart(document.getElementById('chartOverall').getContext('2d'), {
        type:'pie',
        data:{ labels:["Belum mulai","Sudah mulai"], datasets:[{ data:[notStarted, started] }] },
        options:{ plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=>{
          const c = ctx.parsed||0; return `${ctx.label}: ${c}/${total} (${pct(c,total)})`;
        }}}}}
      });
      document.getElementById('overallText').textContent =
        `Overall (berdasarkan ${total} check-in): ${pct(notStarted,total)} Belum mulai · ${pct(started,total)} Sudah mulai`;
    }

    async function refresh(){
      try{
        const data = await loadData();
        render(data);
        document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      }catch(e){
        console.error(e);
        document.getElementById('lastUpdated').textContent = 'Gagal ambil data (cek ENDPOINT & izin Web App).';
      }
    }
    document.getElementById('btnRefresh').addEventListener('click', refresh);
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
