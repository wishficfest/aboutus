<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Author Progress ‚Äî Wish Fic Fest</title>

  <!-- ====== Base styles (pakai global-mu + tambahan di bawah) ====== -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://esm.sh" />

  <style>
    :root{
      --parchment:#f3e7d4; --ink:#222; --muted:#6d5f4f; --accent:#245f47;
      --card:#fff; --shadow:0 10px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box} body{margin:0;background:var(--parchment);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{text-decoration:none;color:var(--accent)}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #d8c9ad;background:#fff;font-weight:800}
    .btn:hover{filter:brightness(.97)}
    .btn.solid{background:#1f6f5a;color:#fff;border-color:transparent}
    h1{font-size:clamp(24px,4.6vw,40px);margin:6px 0 4px}
    .muted{color:var(--muted)}

    /* Layout kiri form ‚Äì kanan board */
    .flex{display:grid;grid-template-columns:320px 1fr;gap:18px;align-items:start}
    @media (max-width:820px){ .flex{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font:inherit}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}

    /* Board grid */
    .board{background:#fff;border-radius:16px;box-shadow:var(--shadow);min-height:380px;padding:18px;
           display:grid;grid-template-columns:repeat(auto-fill, minmax(220px,1fr));gap:16px}
    .note{position:relative;border-radius:12px;padding:12px 14px;word-break:break-word;
          box-shadow:0 6px 16px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.06)}
    .note small{display:block;margin-top:8px;opacity:.7}
    .note .del{position:absolute;top:6px;right:6px;border:none;background:transparent;cursor:pointer;
               font-weight:900;opacity:.35}
    .note .del:hover{opacity:.9}

    /* Warna post-it */
    .note.yellow{background:#fff9b1}
    .note.pink  {background:#ffd6e7}
    .note.blue  {background:#d6f7ff}
    .note.green {background:#e9ffd8}
    .note.purple{background:#f0d6ff}
    .note.orange{background:#ffe5b4}

    /* Counter + info */
    .rowhint{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:13px}
    .counter{opacity:.7}
    .danger{color:#b03a3a}

    /* Footer CTAs */
    .cta-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:22px 0}
    @media (max-width:820px){ .cta-grid{grid-template-columns:1fr} }
    .cta{background:#fff;border-radius:16px;padding:22px;box-shadow:var(--shadow)}
    .cta h3{margin:0 0 12px;text-align:center}
    .btn-cta{display:block;text-align:center;background:#245f47;color:#fff;padding:14px 18px;border-radius:12px;font-weight:800}
    .btn-cta:hover{filter:brightness(.96)}

    /* Reset all */
    .resetbar{display:flex;justify-content:flex-end;margin-top:8px}
    .resetbar .btn{background:#fff4f4;border-color:#f2b8b8}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Top nav -->
    <div class="toolbar">
      <a class="btn" href="../index.html">‚Üê Back to Front Page</a>
      <a class="btn" href="../faq.html">‚Üê Back to FAQ</a>
      <a class="btn" href="../timeline.html#checkin">‚Üê Back to Timeline</a>
    </div>

    <!-- Hero -->
    <h1>Thank you so much for signing up, dear author!</h1>
    <p class="muted" style="margin-top:-6px">Tinggalkan pesan semangat untuk author (anon boleh) üíå</p>

    <!-- Content -->
    <div class="flex">
      <!-- Left: form -->
      <div class="card">
        <input id="alias" maxlength="20" placeholder="Nama / anon" />
        <div class="rowhint">
          <span class="muted">Maks 220 huruf</span>
          <span id="count" class="counter">0/220</span>
        </div>
        <textarea id="message" rows="5" maxlength="220" placeholder="Tulis semangatmu (maks 220 huruf)..."></textarea>
        <div class="actions">
          <button id="postBtn" class="btn solid">‚ú® Post</button>
          <span id="tip" class="muted"></span>
        </div>
      </div>

      <!-- Right: board -->
      <div class="card" style="padding:0">
        <div class="board" id="board" aria-live="polite"></div>
        <div class="resetbar">
          <button id="resetBtn" class="btn" title="Hapus semua catatan (sementara, butuh policy delete)">üóëÔ∏è Reset All</button>
        </div>
      </div>
    </div>

    <!-- Bottom CTAs -->
    <div class="cta-grid">
      <div class="cta">
        <h3>AO3 Pages</h3>
        <a class="btn-cta" target="_blank" rel="noopener" href="https://archiveofourown.org/collections/WishfulThoughtsFest2025/works">Open AO3 Works</a>
      </div>
      <div class="cta">
        <h3>Back to Front Page</h3>
        <a class="btn-cta" href="../index.html">Go to Home</a>
      </div>
    </div>

  </div>

  <!-- Supabase + app logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ====== Supabase config (punyamu) ======
    const PROJECT_ID = "daaazpzydtkustcblyee";
    const SUPABASE_URL = `https://${PROJECT_ID}.supabase.co`;
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYWF6cHp5ZHRrdXN0Y2JseWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDI5MDQsImV4cCI6MjA3MjIxODkwNH0.WOuTidQd_IM5qu1yYUhuZSzhXTkKBk6cyBrXJY2TcHY`;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UI nodes
    const board = document.getElementById("board");
    const postBtn = document.getElementById("postBtn");
    const resetBtn = document.getElementById("resetBtn");
    const aliasEl = document.getElementById("alias");
    const msgEl = document.getElementById("message");
    const tipEl = document.getElementById("tip");
    const countEl = document.getElementById("count");

    // Prefill alias
    aliasEl.value = localStorage.getItem("wish_wall_alias") || "";

    msgEl.addEventListener("input", () => {
      countEl.textContent = `${msgEl.value.length}/220`;
    });

    const COLORS = ["yellow","pink","blue","green","purple","orange"];

    function toast(t, danger=false){
      tipEl.textContent = t;
      tipEl.classList.toggle("danger", !!danger);
      if(t) setTimeout(()=>{tipEl.textContent=""; tipEl.classList.remove("danger")}, 3500);
    }

    function pickColor(){ return COLORS[Math.floor(Math.random()*COLORS.length)]; }

    async function loadNotes(){
      const { data, error } = await supabase
        .from("wall_notes")
        .select("id, alias, message, color, created_at")
        .order("created_at", { ascending:false })
        .limit(500);
      if (error){ console.error(error); toast("Gagal load data", true); return; }
      renderNotes(data || []);
    }

    function renderNotes(list){
      board.replaceChildren();
      list.forEach(n => {
        const div = document.createElement("div");
        div.className = "note " + (n.color || "yellow");
        div.innerHTML = `
          <button class="del" title="Delete" aria-label="Delete">‚úï</button>
          <div class="text">${escapeHTML(n.message)}</div>
          <small>‚Äî ${escapeHTML(n.alias || "anon")}</small>
        `;
        // Delete handler
        div.querySelector(".del").addEventListener("click", async ()=>{
          if(!confirm("Hapus catatan ini?")) return;
          const { error } = await supabase.from("wall_notes").delete().eq("id", n.id);
          if (error){ console.error(error); toast("Gagal hapus (cek policy delete).", true); }
          else { div.remove(); }
        });
        board.appendChild(div);
      });
    }

    postBtn.addEventListener("click", async ()=>{
      const alias = (aliasEl.value || "anon").trim().slice(0,20);
      const message = (msgEl.value || "").trim();
      if(!message){ toast("Pesan tidak boleh kosong.", true); return; }
      if(message.length > 220){ toast("Kepanjangan (maks 220).", true); return; }

      const color = pickColor();
      postBtn.disabled = true;
      const { error } = await supabase
        .from("wall_notes")
        .insert({ alias, message, color });
      postBtn.disabled = false;

      if (error){ console.error(error); toast("Gagal post (cek RLS/policy).", true); return; }
      localStorage.setItem("wish_wall_alias", alias);
      msgEl.value = ""; countEl.textContent = "0/220";
      await loadNotes();   // refresh list
      toast("Terkirim! üíå");
    });

    resetBtn.addEventListener("click", async ()=>{
      if(!confirm("Hapus SEMUA catatan? (sementara untuk demo)")) return;
      const { error } = await supabase.from("wall_notes").delete().neq("id", "00000000-0000-0000-0000-000000000000");
      if (error){ console.error(error); toast("Gagal reset (cek policy delete).", true); return; }
      await loadNotes();
      toast("Dinding dikosongkan.");
    });

    function escapeHTML(s){return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // Start
    loadNotes();
  </script>
</body>
</html>
